# Vagrantfile for SQL Practice C++ Build Environment
# This sets up a Ubuntu VM with all build tools

Vagrant.configure("2") do |config|
  # Use Ubuntu 22.04 LTS (64-bit)
  config.vm.box = "ubuntu/jammy64"
  config.vm.box_version = ">= 0"

  # VM Configuration
  config.vm.hostname = "sql-practice-build"

  # Resources
  config.vm.provider "virtualbox" do |vb|
    vb.name = "sql-practice-build"
    vb.memory = "8192"  # 8 GB RAM
    vb.cpus = 8         # 8 CPU cores
    vb.gui = false      # Headless mode
  end

  # Network
  # Port forwarding for the server (Windows 8082 -> VM 9000)
  config.vm.network "forwarded_port", guest: 9000, host: 8082

  # Sync project folder
  # Windows path will be mounted at /vagrant in the VM
  config.vm.synced_folder ".", "/vagrant", disabled: true
  config.vm.synced_folder "../", "/home/vagrant/project"

  # Provisioning: Install build tools
  config.vm.provision "shell", inline: <<-SHELL
    # Update package list
    apt-get update

    # Install essential build tools
    apt-get install -y build-essential cmake git wget curl pkg-config

    # Install DuckDB
    cd /tmp
    wget -q https://github.com/duckdb/duckdb/releases/download/v1.0.0/libduckdb-linux-amd64.zip
    unzip -q libduckdb-linux-amd64.zip
    cp libduckdb-linux-amd64/*.so* /usr/local/lib/
    cp libduckdb-linux-amd64/*.h /usr/local/include/
    ldconfig

    # Create project directory structure
    mkdir -p /home/vagrant/build
    chown -R vagrant:vagrant /home/vagrant

    # Print setup completion
    echo "=========================================="
    echo "Build environment ready!"
    echo "=========================================="
    echo "To build the project:"
    echo "  cd /home/vagrant/project/cplusplus"
    echo "  mkdir build && cd build"
    echo "  cmake .."
    echo "  make -j8"
    echo "=========================================="
  SHELL

  # Increase file descriptor limit for high concurrency
  config.vm.provision "shell", inline: <<-SHELL
    # Increase file descriptor limit to 100K
    echo "* soft nofile 100000" >> /etc/security/limits.conf
    echo "* hard nofile 100000" >> /etc/security/limits.conf
    echo "root soft nofile 100000" >> /etc/security/limits.conf
    echo "root hard nofile 100000" >> /etc/security/limits.conf

    # Increase somaxconn for TCP connections
    echo "net.core.somaxconn = 65536" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_max_syn_backlog = 65536" >> /etc/sysctl.conf

    # Apply changes
    sysctl -p

    echo "âœ… System limits updated: 100K file descriptors, 65K connection queue"
  SHELL

  # Run additional provisioning script
  config.vm.provision "shell", path: "vagrant-setup.sh", run: "always"

  # Post-start message
  config.vm.post_up_message = <<-MSG
    SQL Practice Build VM is running!

    To connect: vagrant ssh
    To build: cd /home/vagrant/project/cplusplus && mkdir build && cd build && cmake .. && make -j8

    Your Windows files are synced to: /home/vagrant/project/
  MSG
end
